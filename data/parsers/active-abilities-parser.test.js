const abilityParser = require('./active-abilities-parser');

it('parse active abilities from treerazer', () => {
  const input = `<b>Speed</b> 60 feet, fly 60 feet, swim 40 feet; <a style="text-decoration:underline" href="Spells.aspx?ID=128"><i>freedom of movement</i></a><br /><span class="hanging-indent"><b>Melee</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> <i>Blackaxe</i> +47 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+42/+37</u></a>] (<a href="Traits.aspx?ID=3"><u>acid</a></u>, <a href="Traits.aspx?ID=25"><u>chaotic</a></u>, <a href="Traits.aspx?ID=64"><u>evil</a></u>, <a href="Traits.aspx?ID=103"><u>magical</a></u>, <a href="Traits.aspx?ID=192"><u>reach 15 feet</a></u>, <a href="Traits.aspx?ID=194"><u>sweep</a></u>), <b>Damage</b> 4d12+15 slashing plus 1d6 acid, 1d6 chaotic, and 1d6 evil, and 2d6 slashing vs. plants</span><span class="hanging-indent"><b>Melee</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> jaws +45 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+41/+37</u></a>] (<a href="Traits.aspx?ID=170"><u>agile</a></u>, <a href="Traits.aspx?ID=25"><u>chaotic</a></u>, <a href="Traits.aspx?ID=64"><u>evil</a></u>, <a href="Traits.aspx?ID=103"><u>magical</a></u>, <a href="Traits.aspx?ID=192"><u>reach 15 feet</a></u>), <b>Damage</b> 4d10+18 slashing plus 2d6 chaotic and 2d6 evil</span><b>Primal Innate Spells</b> DC 49, attack +43; <b>10th</b> <i><u><a href="Spells.aspx?ID=152">horrid wilting</a></u></i>, <i><u><a href="Spells.aspx?ID=339">time stop</a></u></i>, <i><u><a href="Spells.aspx?ID=366">wall of thorns</a></u></i>; <b>9th</b> <i><u><a href="Spells.aspx?ID=492">abyssal wrath</a></u></i> (at will), <i><u><a href="Spells.aspx?ID=78">dispel magic</a></u></i> (at will); <b>6th</b> <i><u><a href="Spells.aspx?ID=331">tangling creepers</a></u></i> (at will); <b>5th</b> <i><u><a href="Spells.aspx?ID=1">abyssal plague</a></u></i> (at will); <b>3rd</b> <i><u><a href="Spells.aspx?ID=94">earthbind</a></u></i> (at will); <b>2nd</b> <i><u><a href="Spells.aspx?ID=333">telekinetic maneuver</a></u></i> (at will); <b>Cantrips</b> <b>(9th)</b> <i><u><a href="Spells.aspx?ID=334">telekinetic projectile</a></u></i>; <b>Constant</b> <b>(8th)</b> <i><u><a href="Spells.aspx?ID=344">true seeing</a></u></i>; <b>(4th)</b> <i><u><a href="Spells.aspx?ID=128">freedom of movement</a></u></i><br /><b>Primal Rituals</b> DC 49; <b>5th</b> <i><u><a href="Rituals.aspx?ID=16">planar ally</a></u></i>; <b>1st</b> <i><u><a href="Rituals.aspx?ID=21">abyssal pact</a></u></i><br /><span class="hanging-indent"><b>Defoliation</b> <img class="actiondark" alt="Two Actions" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\TwoActions.png"><img class="actionlight" alt="Two Actions" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\TwoActions_I.png">  (<a href="Traits.aspx?ID=134"><u>primal</a></u>, <a href="Traits.aspx?ID=117"><u>necromancy</a></u>, <a href="Traits.aspx?ID=125"><u>plant</a></u>) Treerazer exudes a pulse of sickly green light in a 30-foot-radius emanation. All plants in the area (including creatures under the effect of his aura of corruption) blacken and wither. Non-creature plants immediately wither and die. Plant creatures take 20d8 negative damage with a DC 49 basic Fortitude save. A creature that fails its save is doomed 1 for 1 minute and sickened 3. Treerazer can choose to exclude any number of plants in the area from this effect, and generally does so to preserve twisted and corrupted plants or fungi, or plant creatures that are allied to his cause. Treerazer can't use Defoliation for 1d4 rounds.</span><span class="hanging-indent"><b>Dispelling Strike</b> <img class="actiondark" alt="Free Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\FreeAction.png"><img class="actionlight" alt="Free Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\FreeAction_I.png">  (<a href="Traits.aspx?ID=2"><u>abjuration</a></u>, <a href="Traits.aspx?ID=134"><u>primal</a></u>) <b>Frequency</b> once per round; <b>Trigger</b> Treerazer hits a creature, object, or spell effect with a weapon Strike or a defoliation attack. <b>Effect</b> Treerazer casts his innate dispel magic, targeting the creature he hit with his Strike or one spell affecting that creature.</span><span class="hanging-indent"><b>Staggering Strike</b> When Treerazer scores a critical hit with a melee attack, the target is stunned 2.</span>`;
  const fields = abilityParser(input);

  const abilityNames = fields.active_abilities.map(({ name }) => name);
  expect(abilityNames).toEqual([
    'Defoliation',
    'Dispelling Strike',
    'Staggering Strike',
  ]);
});

it('parse active abilities from gelugon', () => {
  const input = `<b>Speed</b> 35 feet, fly 35 feet (from <a style="text-decoration:underline" href="Spells.aspx?ID=125"><i>fly</i></a>)<br /><span class="hanging-indent"><b>Melee</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> <i>frost longspear</i> +28 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+23/+18</u></a>] (<a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=64"><u>evil</a></u>, <a href="Traits.aspx?ID=103"><u>magical</a></u>, <a href="Traits.aspx?ID=192"><u>reach 15 feet</a></u>), <b>Damage</b> 2d8+12 piercing plus 1d6 cold, 1d6 evil, and slowing frost</span><span class="hanging-indent"><b>Melee</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> tail +25 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+21/+17</u></a>] (<a href="Traits.aspx?ID=170"><u>agile</a></u>, <a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=64"><u>evil</a></u>, <a href="Traits.aspx?ID=103"><u>magical</a></u>, <a href="Traits.aspx?ID=192"><u>reach 10 feet</a></u>), <b>Damage</b> 2d6+12 bludgeoning plus 2d6 cold, 1d6 evil, and slowing frost</span><span class="hanging-indent"><b>Ranged</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> <i>frost longspear</i> +27 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+22/+17</u></a>] (<a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=103"><u>magical</a></u>, <a href="Traits.aspx?ID=195"><u>thrown 20 feet</a></u>), <b>Damage</b> 2d8+12 piercing plus 1d6 cold</span><b>Divine Innate Spells</b> DC 33; <b>7th</b> <i><u><a href="Spells.aspx?ID=47">cone of cold</a></u></i> (x2); <b>6th</b> <i><u><a href="Spells.aspx?ID=161">illusory scene</a></u></i>; <b>5th</b> <i><u><a href="Spells.aspx?ID=69">dimension door</a></u></i>, <i><u><a href="Spells.aspx?ID=364">wall of ice</a></u></i> (x3); <b>4th</b> <i><u><a href="Spells.aspx?ID=69">dimension door</a></u></i> (at will); <b>Cantrips</b> <b>(7th)</b> <i><u><a href="Spells.aspx?ID=245">ray of frost</a></u></i>; <b>Constant</b> <b>(4th)</b> <i><u><a href="Spells.aspx?ID=125">fly</a></u></i><br /><b>Rituals</b> DC 33; <b>1st</b> <i><u><a href="Rituals.aspx?ID=23">infernal pact</a></u></i><br /><span class="hanging-indent"><b>Slowing Frost</b> (<a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=48"><u>divine</a></u>, <a href="Traits.aspx?ID=65"><u>evocation</a></u>) The ice devil channels the extreme cold of its body through its appendages and weapons. A creature hit by an ice devil's weapon or unarmed attack in melee must attempt a DC 32 Fortitude save or be <a style="text-decoration:underline" href="Conditions.aspx?ID=35">slowed 1</a> for 1d4 rounds. A weapon used by an ice devil gains the effects of a <a style="text-decoration:underline" href="Equipment.aspx?ID=296">frost rune</a> while the gelugon holds it, and the ice devil can throw any such weapon with a 20-foot range increment, trailing motes of frost.</span><span class="hanging-indent"><b>Tactician of Cocytus</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png">  (<a href="Traits.aspx?ID=32"><u>concentrate</a></u>) An ice devil's logical mind devises genius tactics from its perfect memory. It can telepathically send a tactical repositioning to its allies, allowing all commanded or allied evil creatures in the range of its telepathy to immediately Stride (or Burrow, Climb, Fly, or Swim, if the creature has the corresponding Speed).</span>`;
  const fields = abilityParser(input);

  const abilityNames = fields.active_abilities.map(({ name }) => name);
  expect(abilityNames).toEqual([
    'Slowing Frost',
    'Tactician of Cocytus',
  ]);
});

it('parse melee attack from gelugon', () => {
  const input = `<b>Speed</b> 35 feet, fly 35 feet (from <a style="text-decoration:underline" href="Spells.aspx?ID=125"><i>fly</i></a>)<br /><span class="hanging-indent"><b>Melee</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> <i>frost longspear</i> +28 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+23/+18</u></a>] (<a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=64"><u>evil</a></u>, <a href="Traits.aspx?ID=103"><u>magical</a></u>, <a href="Traits.aspx?ID=192"><u>reach 15 feet</a></u>), <b>Damage</b> 2d8+12 piercing plus 1d6 cold, 1d6 evil, and slowing frost</span><span class="hanging-indent"><b>Melee</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> tail +25 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+21/+17</u></a>] (<a href="Traits.aspx?ID=170"><u>agile</a></u>, <a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=64"><u>evil</a></u>, <a href="Traits.aspx?ID=103"><u>magical</a></u>, <a href="Traits.aspx?ID=192"><u>reach 10 feet</a></u>), <b>Damage</b> 2d6+12 bludgeoning plus 2d6 cold, 1d6 evil, and slowing frost</span><span class="hanging-indent"><b>Ranged</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> <i>frost longspear</i> +27 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+22/+17</u></a>] (<a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=103"><u>magical</a></u>, <a href="Traits.aspx?ID=195"><u>thrown 20 feet</a></u>), <b>Damage</b> 2d8+12 piercing plus 1d6 cold</span><b>Divine Innate Spells</b> DC 33; <b>7th</b> <i><u><a href="Spells.aspx?ID=47">cone of cold</a></u></i> (x2); <b>6th</b> <i><u><a href="Spells.aspx?ID=161">illusory scene</a></u></i>; <b>5th</b> <i><u><a href="Spells.aspx?ID=69">dimension door</a></u></i>, <i><u><a href="Spells.aspx?ID=364">wall of ice</a></u></i> (x3); <b>4th</b> <i><u><a href="Spells.aspx?ID=69">dimension door</a></u></i> (at will); <b>Cantrips</b> <b>(7th)</b> <i><u><a href="Spells.aspx?ID=245">ray of frost</a></u></i>; <b>Constant</b> <b>(4th)</b> <i><u><a href="Spells.aspx?ID=125">fly</a></u></i><br /><b>Rituals</b> DC 33; <b>1st</b> <i><u><a href="Rituals.aspx?ID=23">infernal pact</a></u></i><br /><span class="hanging-indent"><b>Slowing Frost</b> (<a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=48"><u>divine</a></u>, <a href="Traits.aspx?ID=65"><u>evocation</a></u>) The ice devil channels the extreme cold of its body through its appendages and weapons. A creature hit by an ice devil's weapon or unarmed attack in melee must attempt a DC 32 Fortitude save or be <a style="text-decoration:underline" href="Conditions.aspx?ID=35">slowed 1</a> for 1d4 rounds. A weapon used by an ice devil gains the effects of a <a style="text-decoration:underline" href="Equipment.aspx?ID=296">frost rune</a> while the gelugon holds it, and the ice devil can throw any such weapon with a 20-foot range increment, trailing motes of frost.</span><span class="hanging-indent"><b>Tactician of Cocytus</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png">  (<a href="Traits.aspx?ID=32"><u>concentrate</a></u>) An ice devil's logical mind devises genius tactics from its perfect memory. It can telepathically send a tactical repositioning to its allies, allowing all commanded or allied evil creatures in the range of its telepathy to immediately Stride (or Burrow, Climb, Fly, or Swim, if the creature has the corresponding Speed).</span>`;

  const fields = abilityParser(input);

  const names = fields.melee_attacks.map(x => x.name);

  expect(names).toEqual([
    'frost longspear',
    'tail',
  ]);
});

it('parse ranged attack from gelugon', () => {
  const input = `<b>Speed</b> 35 feet, fly 35 feet (from <a style="text-decoration:underline" href="Spells.aspx?ID=125"><i>fly</i></a>)<br /><span class="hanging-indent"><b>Melee</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> <i>frost longspear</i> +28 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+23/+18</u></a>] (<a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=64"><u>evil</a></u>, <a href="Traits.aspx?ID=103"><u>magical</a></u>, <a href="Traits.aspx?ID=192"><u>reach 15 feet</a></u>), <b>Damage</b> 2d8+12 piercing plus 1d6 cold, 1d6 evil, and slowing frost</span><span class="hanging-indent"><b>Melee</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> tail +25 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+21/+17</u></a>] (<a href="Traits.aspx?ID=170"><u>agile</a></u>, <a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=64"><u>evil</a></u>, <a href="Traits.aspx?ID=103"><u>magical</a></u>, <a href="Traits.aspx?ID=192"><u>reach 10 feet</a></u>), <b>Damage</b> 2d6+12 bludgeoning plus 2d6 cold, 1d6 evil, and slowing frost</span><span class="hanging-indent"><b>Ranged</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> <i>frost longspear</i> +27 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+22/+17</u></a>] (<a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=103"><u>magical</a></u>, <a href="Traits.aspx?ID=195"><u>thrown 20 feet</a></u>), <b>Damage</b> 2d8+12 piercing plus 1d6 cold</span><b>Divine Innate Spells</b> DC 33; <b>7th</b> <i><u><a href="Spells.aspx?ID=47">cone of cold</a></u></i> (x2); <b>6th</b> <i><u><a href="Spells.aspx?ID=161">illusory scene</a></u></i>; <b>5th</b> <i><u><a href="Spells.aspx?ID=69">dimension door</a></u></i>, <i><u><a href="Spells.aspx?ID=364">wall of ice</a></u></i> (x3); <b>4th</b> <i><u><a href="Spells.aspx?ID=69">dimension door</a></u></i> (at will); <b>Cantrips</b> <b>(7th)</b> <i><u><a href="Spells.aspx?ID=245">ray of frost</a></u></i>; <b>Constant</b> <b>(4th)</b> <i><u><a href="Spells.aspx?ID=125">fly</a></u></i><br /><b>Rituals</b> DC 33; <b>1st</b> <i><u><a href="Rituals.aspx?ID=23">infernal pact</a></u></i><br /><span class="hanging-indent"><b>Slowing Frost</b> (<a href="Traits.aspx?ID=27"><u>cold</a></u>, <a href="Traits.aspx?ID=48"><u>divine</a></u>, <a href="Traits.aspx?ID=65"><u>evocation</a></u>) The ice devil channels the extreme cold of its body through its appendages and weapons. A creature hit by an ice devil's weapon or unarmed attack in melee must attempt a DC 32 Fortitude save or be <a style="text-decoration:underline" href="Conditions.aspx?ID=35">slowed 1</a> for 1d4 rounds. A weapon used by an ice devil gains the effects of a <a style="text-decoration:underline" href="Equipment.aspx?ID=296">frost rune</a> while the gelugon holds it, and the ice devil can throw any such weapon with a 20-foot range increment, trailing motes of frost.</span><span class="hanging-indent"><b>Tactician of Cocytus</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png">  (<a href="Traits.aspx?ID=32"><u>concentrate</a></u>) An ice devil's logical mind devises genius tactics from its perfect memory. It can telepathically send a tactical repositioning to its allies, allowing all commanded or allied evil creatures in the range of its telepathy to immediately Stride (or Burrow, Climb, Fly, or Swim, if the creature has the corresponding Speed).</span>`;

  const fields = abilityParser(input);

  const names = fields.ranged_attacks.map(x => x.name);

  expect(names).toEqual([
    'frost longspear',
  ]);
});

it('parse active abilities from devourer', () => {
  const input = `<b>Speed</b> 30 feet, fly 30 feet<br /><span class="hanging-indent"><b>Melee</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> claw +24 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+20/+16</u></a>] (<a href="Traits.aspx?ID=170"><u>agile</a></u>, <a href="Traits.aspx?ID=192"><u>reach 10 feet</a></u>), <b>Damage</b> 2d10+13 slashing plus drain life</span><b>Occult Innate Spells</b> DC 31, see soul spells below; <b>6th</b> <i><u><a href="Spells.aspx?ID=112">feeblemind</a></u></i>, <i><u><a href="Spells.aspx?ID=344">true seeing</a></u></i>; <b>4th</b> <i><u><a href="Spells.aspx?ID=48">confusion</a></u></i>, <i><u><a href="Spells.aspx?ID=315">suggestion</a></u></i>; <b>3rd</b> <i><u><a href="Spells.aspx?ID=22">bind undead</a></u></i>, <i><u><a href="Spells.aspx?ID=213">paralyze</a></u></i>; <b>2nd</b> <i><u><a href="Spells.aspx?ID=63">death knell</a></u></i>; <b>1st</b> <i><u><a href="Spells.aspx?ID=146">harm</a></u></i><br /><b>Rituals</b> DC 31; <b>2nd</b> <i><u><a href="Rituals.aspx?ID=10">create undead</a></u></i><br /><span class="hanging-indent"><b>Devour Soul</b> <img class="actiondark" alt="Two Actions" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\TwoActions.png"><img class="actionlight" alt="Two Actions" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\TwoActions_I.png">  (<a href="Traits.aspx?ID=40"><u>death</a></u>, <a href="Traits.aspx?ID=48"><u>divine</a></u>, <a href="Traits.aspx?ID=117"><u>necromancy</a></u>) The devourer touches a creature within reach, dealing 8d6 negative damage (DC 31 basic Fortitude save). If a creature is slain by this attack, its soul becomes trapped within the devourer. While its soul is trapped, a creature can't be resurrected except by powerful magic such as a <a style="text-decoration:underline" href="Spells.aspx?ID=377"><i>wish</i></a> spell. Destroying the devourer or successfully counteracting Devour Soul (see Spell Deflection above) releases the soul. The devourer can hold only one soul at a time. A soul has 5 soul charges per level of the originating creature (see Soul Spells below). The devourer can expend these charges to cast spells. If the soul is freed and the creature returns to life, the creature is drained 1 for every 5 soul charges expended. If reduced to 0 soul charges, the soul is consumed and can be restored to life only by powerful magic such as <i>wish</i>.</span><span class="hanging-indent"><b>Drain Life</b> (<a href="Traits.aspx?ID=48"><u>divine</a></u>, <a href="Traits.aspx?ID=117"><u>necromancy</a></u>) When the devourer damages a living creature with its claw Strike, the devourer gains 10 temporary Hit Points and the creature must succeed at a DC 24 Fortitude save or become <a style="text-decoration:underline" href="Conditions.aspx?ID=10">drained 1</a>. Further damage dealt by the devourer increases the condition value by 1 on a failed save, to a maximum of drained 4.</span><span class="hanging-indent"><b>Soul Spells</b> A devourer casts occult innate spells, but to do so it must expend a number of soul charges equal to the spell's level (similar to casting a spell using charges from a staff). It can heighten any spell to a maximum of 6th level by expending more charges as it Casts the Spell. When encountered, a devourer typically has one trapped soul with 10 soul charges.</span>`;

  const fields = abilityParser(input);

  const names = fields.melee_attacks.map(x => x.name);

  expect(names).toEqual([
    'claw',
  ]);
});

it('parse melee attacks from devourer', () => {
  const input = `<b>Speed</b> 30 feet, fly 30 feet<br /><span class="hanging-indent"><b>Melee</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> claw +24 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+20/+16</u></a>] (<a href="Traits.aspx?ID=170"><u>agile</a></u>, <a href="Traits.aspx?ID=192"><u>reach 10 feet</a></u>), <b>Damage</b> 2d10+13 slashing plus drain life</span><b>Occult Innate Spells</b> DC 31, see soul spells below; <b>6th</b> <i><u><a href="Spells.aspx?ID=112">feeblemind</a></u></i>, <i><u><a href="Spells.aspx?ID=344">true seeing</a></u></i>; <b>4th</b> <i><u><a href="Spells.aspx?ID=48">confusion</a></u></i>, <i><u><a href="Spells.aspx?ID=315">suggestion</a></u></i>; <b>3rd</b> <i><u><a href="Spells.aspx?ID=22">bind undead</a></u></i>, <i><u><a href="Spells.aspx?ID=213">paralyze</a></u></i>; <b>2nd</b> <i><u><a href="Spells.aspx?ID=63">death knell</a></u></i>; <b>1st</b> <i><u><a href="Spells.aspx?ID=146">harm</a></u></i><br /><b>Rituals</b> DC 31; <b>2nd</b> <i><u><a href="Rituals.aspx?ID=10">create undead</a></u></i><br /><span class="hanging-indent"><b>Devour Soul</b> <img class="actiondark" alt="Two Actions" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\TwoActions.png"><img class="actionlight" alt="Two Actions" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\TwoActions_I.png">  (<a href="Traits.aspx?ID=40"><u>death</a></u>, <a href="Traits.aspx?ID=48"><u>divine</a></u>, <a href="Traits.aspx?ID=117"><u>necromancy</a></u>) The devourer touches a creature within reach, dealing 8d6 negative damage (DC 31 basic Fortitude save). If a creature is slain by this attack, its soul becomes trapped within the devourer. While its soul is trapped, a creature can't be resurrected except by powerful magic such as a <a style="text-decoration:underline" href="Spells.aspx?ID=377"><i>wish</i></a> spell. Destroying the devourer or successfully counteracting Devour Soul (see Spell Deflection above) releases the soul. The devourer can hold only one soul at a time. A soul has 5 soul charges per level of the originating creature (see Soul Spells below). The devourer can expend these charges to cast spells. If the soul is freed and the creature returns to life, the creature is drained 1 for every 5 soul charges expended. If reduced to 0 soul charges, the soul is consumed and can be restored to life only by powerful magic such as <i>wish</i>.</span><span class="hanging-indent"><b>Drain Life</b> (<a href="Traits.aspx?ID=48"><u>divine</a></u>, <a href="Traits.aspx?ID=117"><u>necromancy</a></u>) When the devourer damages a living creature with its claw Strike, the devourer gains 10 temporary Hit Points and the creature must succeed at a DC 24 Fortitude save or become <a style="text-decoration:underline" href="Conditions.aspx?ID=10">drained 1</a>. Further damage dealt by the devourer increases the condition value by 1 on a failed save, to a maximum of drained 4.</span><span class="hanging-indent"><b>Soul Spells</b> A devourer casts occult innate spells, but to do so it must expend a number of soul charges equal to the spell's level (similar to casting a spell using charges from a staff). It can heighten any spell to a maximum of 6th level by expending more charges as it Casts the Spell. When encountered, a devourer typically has one trapped soul with 10 soul charges.</span>`;

  const fields = abilityParser(input);

  const names = fields.active_abilities.map(x => x.name);

  expect(names).toEqual([
    'Devour Soul',
    'Drain Life',
    'Soul Spells',
  ]);
});

it('parse spells from devourer', () => {
  const input = `<b>Speed</b> 30 feet, fly 30 feet<br /><span class="hanging-indent"><b>Melee</b> <img class="actiondark" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction.png"><img class="actionlight" alt="Single Action" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\OneAction_I.png"> claw +24 [<a style="text-decoration:underline" href="Rules.aspx?ID=322"><u>+20/+16</u></a>] (<a href="Traits.aspx?ID=170"><u>agile</a></u>, <a href="Traits.aspx?ID=192"><u>reach 10 feet</a></u>), <b>Damage</b> 2d10+13 slashing plus drain life</span><b>Occult Innate Spells</b> DC 31, see soul spells below; <b>6th</b> <i><u><a href="Spells.aspx?ID=112">feeblemind</a></u></i>, <i><u><a href="Spells.aspx?ID=344">true seeing</a></u></i>; <b>4th</b> <i><u><a href="Spells.aspx?ID=48">confusion</a></u></i>, <i><u><a href="Spells.aspx?ID=315">suggestion</a></u></i>; <b>3rd</b> <i><u><a href="Spells.aspx?ID=22">bind undead</a></u></i>, <i><u><a href="Spells.aspx?ID=213">paralyze</a></u></i>; <b>2nd</b> <i><u><a href="Spells.aspx?ID=63">death knell</a></u></i>; <b>1st</b> <i><u><a href="Spells.aspx?ID=146">harm</a></u></i><br /><b>Rituals</b> DC 31; <b>2nd</b> <i><u><a href="Rituals.aspx?ID=10">create undead</a></u></i><br /><span class="hanging-indent"><b>Devour Soul</b> <img class="actiondark" alt="Two Actions" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\TwoActions.png"><img class="actionlight" alt="Two Actions" style="height:15px; padding:0px 2px 0px 2px" src="Images\Actions\TwoActions_I.png">  (<a href="Traits.aspx?ID=40"><u>death</a></u>, <a href="Traits.aspx?ID=48"><u>divine</a></u>, <a href="Traits.aspx?ID=117"><u>necromancy</a></u>) The devourer touches a creature within reach, dealing 8d6 negative damage (DC 31 basic Fortitude save). If a creature is slain by this attack, its soul becomes trapped within the devourer. While its soul is trapped, a creature can't be resurrected except by powerful magic such as a <a style="text-decoration:underline" href="Spells.aspx?ID=377"><i>wish</i></a> spell. Destroying the devourer or successfully counteracting Devour Soul (see Spell Deflection above) releases the soul. The devourer can hold only one soul at a time. A soul has 5 soul charges per level of the originating creature (see Soul Spells below). The devourer can expend these charges to cast spells. If the soul is freed and the creature returns to life, the creature is drained 1 for every 5 soul charges expended. If reduced to 0 soul charges, the soul is consumed and can be restored to life only by powerful magic such as <i>wish</i>.</span><span class="hanging-indent"><b>Drain Life</b> (<a href="Traits.aspx?ID=48"><u>divine</a></u>, <a href="Traits.aspx?ID=117"><u>necromancy</a></u>) When the devourer damages a living creature with its claw Strike, the devourer gains 10 temporary Hit Points and the creature must succeed at a DC 24 Fortitude save or become <a style="text-decoration:underline" href="Conditions.aspx?ID=10">drained 1</a>. Further damage dealt by the devourer increases the condition value by 1 on a failed save, to a maximum of drained 4.</span><span class="hanging-indent"><b>Soul Spells</b> A devourer casts occult innate spells, but to do so it must expend a number of soul charges equal to the spell's level (similar to casting a spell using charges from a staff). It can heighten any spell to a maximum of 6th level by expending more charges as it Casts the Spell. When encountered, a devourer typically has one trapped soul with 10 soul charges.</span>`;

  const fields = abilityParser(input);

  const names = fields.spell_lists.map(x => x.spells_source);

  expect(names).toEqual([
    'Occult Innate Spells',
    'Rituals',
  ]);
});